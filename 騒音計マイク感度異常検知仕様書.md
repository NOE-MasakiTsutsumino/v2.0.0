# 騒音計マイク感度異常検知仕様書

## １．概要
騒音計マイク感度異常検知システムの仕様を以下に定義する

## 2．仕様

### 2.1．ソフトウェア開発環境
* Windows 11 64bit / Windows 10 64bit
* 開発言語 Python
* 北海道道庁の実験機 DL100(富丘 CH53)からデータを回収して開発する

### 2.2.ハードウェア
- オーディオインターフェース1台
  * TRSもしくはXLRマイク入力端子2つ以上を備える事
  * USB接続でコンピュータに接続できる事
  * オーディオインターフェースはWindowsXP,7,10,11に対応したドライバが用意されている事
  * 入力端子のうち、少なくとも1チャンネルは48Vファンタム電源供給可能なもの
- サブマイク1台
  * 周波数帯域が騒音計の測定範囲と同程度である事、ただし100Hz以下は考慮外
  * オーディオインターフェースから供給されるファンタム電源で駆動する事
  * 無指向性マイクロホンである事
  * 屋外で使用しても問題のない防水性能がある事
  * 屋外で使用しても問題のない動作温度である事
* サブマイク取付用治具

## 3．機能
本システムの機能および処理の流れは以下の通り

### 3.1 単発騒音イベント実音ファイルの保存
* 処理は航空機騒音測定器(DL)の機能で実現する
* 騒音計のAC出力とサブマイクロホン出力はオーディオインターフェースに接続
* DLは単発騒音イベントを録音、2チャンネルのWAVファイルを保存
* WAVファイルのチャンネルマッピングはch1がサブマイク、ch2が騒音計

### 3.2 正常データ算出・保存
* 処理は中央局にインストールしたアプリケーションソフトが実行する
* 定期点検などで校正された騒音計状態のデータを正常データとして算出・保存する処理
* 騒音計マイクロホンの校正毎に手動もしくは自動で実行する

- 正常データの算出・保存方法は以下の通り
  * 指定時刻以降の実音ファイルを指定数読み込み、標本とする
  * 実音ファイルの先頭から指定した平均時間毎に、fftの通過帯域合算によるオクターブバンドレベルを算出して配列に格納
  * 配列データの80パーセントレンジレベルの上端値、下端値およびパワー平均レベルを求める
  * 上記を騒音計、サブマイクごとに算出し差を取る
  * 差を標本の全ての実音ファイルごとに求めて配列に格納
  * 差の配列の不偏分散から、標準偏差を求める
  * 平均値の区間推定により信頼区間の上端値、下端値を求める
  * オクターブバンドごとの標準偏差、信頼区間の上端値、下端値をjsonファイル形式で保存

* 正常データの標本は異常検知の精度に影響を及ぼす為、騒音計-サブマイクの差の値の度数分布などから手動で外れ値を除く、もしくは自動で外れ値を除く処理を入れる事
* 〇%パーセントレンジレベルの〇%、平均値の区間推定における信頼係数は必要に応じてアプリケーションの設定ファイルから変更可能にする事

### 3.3 騒音計の異常診断
マイクの水没、水滴付着等による自己ノイズの発生、騒音計AC出力の故障による録音不良、その他騒音計マイクの故障といった異常検知を行う機能

* 処理は中央局にインストールしたアプリケーションソフトが実行する
* 少なくとも1日1回、自動で実行する事

- 異常検知の流れは以下の通り
  * 対象測定局の正常データを読み込む
  * 対象日の実音ファイルを全て読み込む
  * 実音ファイルごとに以下の方法で異常検知パラメータを算出
    * 実音ファイルの先頭から指定した平均時間毎に、fftの通過帯域合算によるオクターブバンドレベルを算出して配列に格納
    * 配列データの80パーセントレンジレベルの上端値、下端値およびパワー平均レベルを求める
    * 上記を騒音計、サブマイクごとに算出し差を取る
  * 異常検知パラメータと正常データを比較し、異常検知パラメータが正常データ+閾値より外れていたら、アプリケーションログに異常メッセージを出力する

### 3.4 騒音計マイクロホンの感度確認
騒音計マイクの指示値の誤差(器差)が低下・上昇(±0.7dBを想定)していないか判定する機能

* 処理は中央局にインストールしたアプリケーションソフトが実行する
* 少なくとも1日1回、自動で実行する事

- 異常検知の流れは以下の通り
  * 対象測定局の正常データを読み込む
  * 指定時刻から過去に遡り、実音ファイルを指定数読み込む(標本)
  * 標本から異常検知パラメータを算出する
  * 標本に外れ値が含まれていた場合はそれを除いて過去の実音ファイルを新たにサンプリングし、異常検知パラメータの標準偏差が正常データ以下に収まるまで繰り返す
  * ただし、再サンプリングした実音ファイル数が一定数を超える場合は、対象日の異常検知は失敗とする
  * 異常検知パラメータと正常データを比較し、異常検知パラメータが正常データ+閾値より外れていたらアプリケーションログに異常メッセージを出力する

### 3.5 異常の通知
* 処理は中央局にインストールしたアプリケーションソフトが実行する
* 3.3,3.4の機能によって異常が検知された場合に実行される

- 処理の流れ以下の通り
  * 異常メッセージがあるか確認する、無ければ終了
  * 異常メッセージの内容を整理して、windowsイベントログを出力する(レベルはWarning以上に設定)

* 中央局で動作している障害監視ソフトHornがwindowsイベントを検知し、社内の保守端末にヘルプコールを送信する

### 3.6 異常分析の結果および画像保存
* 異常発生時の原因調査用に、データを保存する機能
* 処理は中央局にインストールしたアプリケーションソフトが実行する
* 少なくとも1日1回、自動で実行する事
* 異常の有無にかかわらず、全ての結果を保存する事

* 算出した異常検知パラメータをcsvで保存する
* 異常有無判定の度数分布図を画像で保存する

### 更新履歴
* 2023/10/13　作成　堤野
* 2023/10/13　ソフトウェア機能に関する基本的な仕様をまとめた 堤野
* 2023/10/16　ハードウェア機能に関する基本的な仕様をまとめた 堤野